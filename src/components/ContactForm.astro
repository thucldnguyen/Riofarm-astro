---
export interface Props {
  formName?: string;
}

const { formName = 'contact' } = Astro.props;
---

<section class="contact-form-section section-pad" style="background:#f9f9f9;">
  <div class="container">
    <div class="glass-box">
      <h4 style="font-size:1.5rem;font-weight:700;margin-bottom:1.5rem;text-align:center;">Thông tin khách hàng</h4>
      <form
        name={formName}
        method="POST"
        data-netlify="true"
        id="contact-form"
      >
        <input type="hidden" name="form-name" value={formName} />

        <div class="form-group">
          <label class="form-label" for="name">Họ và Tên *</label>
          <input
            class="form-input"
            type="text"
            id="name"
            name="name"
            required
            placeholder="Nhập họ và tên của bạn"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="phone">Số điện thoại *</label>
          <input
            class="form-input"
            type="tel"
            id="phone"
            name="phone"
            required
            placeholder="Nhập số điện thoại"
          />
        </div>

        <div class="form-group">
          <label class="form-label" for="address">Địa chỉ giao hàng *</label>
          <input
            class="form-input"
            type="text"
            id="address"
            name="address"
            required
            placeholder="Nhập địa chỉ giao hàng"
          />
        </div>

        <div class="form-group" style="background:#eee;padding:1rem;border-radius:6px;">
          <label class="form-label" id="captcha-label">
            Xác nhận bạn không phải là robot: <span id="captcha-question">? + ? = ?</span>
          </label>
          <input
            class="form-input"
            type="number"
            id="captcha-answer"
            name="captchaAnswer"
            required
            placeholder="Câu trả lời"
            style="margin-top:0.5rem;"
          />
        </div>

        <div style="margin-top:1.5rem;">
          <button type="submit" class="btn-primary" style="width:100%;font-size:1.1rem;padding:1rem;">
            Liên Hệ
          </button>
        </div>

        <div id="form-success" style="display:none;color:green;text-align:center;margin-top:1rem;font-weight:600;">
          ✅ Thông tin đã được gửi thành công!
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  // Generate captcha
  let a = Math.floor(Math.random() * 10);
  let b = Math.floor(Math.random() * 10);
  const question = document.getElementById('captcha-question');
  if (question) question.textContent = `${a} + ${b} = ?`;

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const successMsg = document.getElementById('form-success');

  form?.addEventListener('submit', (e) => {
    e.preventDefault();
    const answer = parseInt((document.getElementById('captcha-answer') as HTMLInputElement)?.value || '');
    if (answer !== a + b) {
      alert('Captcha không đúng. Vui lòng thử lại.');
      return;
    }

    const formData = new FormData(form);
    fetch('/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams(formData as any).toString(),
    })
      .then(() => {
        form.reset();
        if (successMsg) successMsg.style.display = 'block';
        // Regenerate captcha
        a = Math.floor(Math.random() * 10);
        b = Math.floor(Math.random() * 10);
        if (question) question.textContent = `${a} + ${b} = ?`;
      })
      .catch((err) => alert(err));
  });
</script>
